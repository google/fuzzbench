name: Build fuzzers
on:
  pull_request:
    paths:
      - 'docker/**'  # Base images changes.
      - 'fuzzers/**' # Changes to fuzzers themselves.
      - 'benchmarks/**'  # Changes to benchmarks.

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        fuzzer:
          - afl
          - aflfast
          - aflplusplus
          - aflsmart
          - eclipser
          - entropic
          - fairfuzz
          - fastcgs
          - honggfuzz
          - libfuzzer
          - mopt
          - qsym
        benchmark:
          - bloaty_fuzz_target
          - curl_curl_fuzzer_http
          - freetype2-2017
          - harfbuzz-1.3.2
          - irssi_server-fuzz
          - jsoncpp_jsoncpp_fuzzer
          - lcms-2017-03-21
          - libjpeg-turbo-07-2017
          - libpcap_fuzz_both
          - libpng-1.2.56
          - libxml2-v2.9.2
          - mbedtls_fuzz_dtlsclient
          - openssl_x509
          - openthread-2019-12-23
          # Disabled because build fills up disk.
          # - php_php-fuzz-parser
          - proj4-2017-08-14
          - re2-2014-12-09
          - sqlite3_ossfuzz
          - systemd_fuzz-link-parser
          - vorbis-2017-12-11
          - woff2-2016-05-06
          - wpantund-2018-02-27
          - zlib_zlib_uncompress_fuzzer

    env:
      FUZZER_NAME: ${{ matrix.fuzzer }}
      BENCHMARK_NAME: ${{ matrix.benchmark }}

    steps:
    - uses: actions/checkout@v2
    - name: Setup Python environment
      uses: actions/setup-python@v1.1.1
      with:
        python-version: 3.7
    - name: Build benchmarks
      run: |
        docker pull gcr.io/fuzzbench/base-image || 0
        docker pull gcr.io/fuzzbench/base-builder || 0
        docker pull gcr.io/fuzzbench/base-runner || 0
        make build-$FUZZER_NAME-$BENCHMARK_NAME
