name: Build fuzzers
on:
  pull_request:
    paths:
      - 'docker/**'  # Base images changes.
      - 'fuzzers/**' # Changes to fuzzers themselves.
      - 'benchmarks/**'  # Changes to benchmarks.

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        fuzzer:
          - afl
          - aflfast
          - aflplusplus
          - aflsmart
          - eclipser
          - entropic
          - fairfuzz
          - fastcgs
          - honggfuzz
          - libfuzzer
          - mopt
          - qsym

    env:
      FUZZER_NAME: ${{ matrix.fuzzer }}

    steps:
    - uses: actions/checkout@v2
    - name: Setup Python environment
      uses: actions/setup-python@v1.1.1
      with:
        python-version: 3.7
    - name: Build benchmarks
      run: |
        docker pull gcr.io/fuzzbench/base-image || 0
        docker pull gcr.io/fuzzbench/base-builder || 0
        docker pull gcr.io/fuzzbench/base-runner || 0
        make build-$FUZZER_NAME-bloaty_fuzz_target \
          build-$FUZZER_NAME-curl_curl_fuzzer_http \
          build-$FUZZER_NAME-freetype2-2017 \
          build-$FUZZER_NAME-harfbuzz-1.3.2 \
          build-$FUZZER_NAME-irssi_server-fuzz \
          build-$FUZZER_NAME-jsoncpp_jsoncpp_fuzzer \
          build-$FUZZER_NAME-lcms-2017-03-21 \
          build-$FUZZER_NAME-libjpeg-turbo-07-2017 \
          build-$FUZZER_NAME-libpcap_fuzz_both \
          build-$FUZZER_NAME-libpng-1.2.56 \
          build-$FUZZER_NAME-libxml2-v2.9.2 \
          build-$FUZZER_NAME-mbedtls_fuzz_dtlsclient \
          build-$FUZZER_NAME-openssl_x509 \
          build-$FUZZER_NAME-openthread-2019-12-23 \
          build-$FUZZER_NAME-proj4-2017-08-14 \
          build-$FUZZER_NAME-re2-2014-12-09 \
          build-$FUZZER_NAME-sqlite3_ossfuzz \
          build-$FUZZER_NAME-systemd_fuzz-link-parser \
          build-$FUZZER_NAME-vorbis-2017-12-11 \
          build-$FUZZER_NAME-woff2-2016-05-06 \
          build-$FUZZER_NAME-wpantund-2018-02-27 \
          build-$FUZZER_NAME-zlib_zlib_uncompress_fuzzer
